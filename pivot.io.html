<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pivot - Project Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc; /* slate-50 */
            --bg-tertiary: #f1f5f9; /* slate-100 */
            --bg-nav: #1e293b; /* slate-800 */
            --bg-nav-hover: #334155; /* slate-700 */
            --bg-active-nav: #4f46e5; /* indigo-600 */
            
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --text-muted: #64748b; /* slate-500 */
            --text-inverted: #f8fafc; /* slate-50 */
            --text-nav: #cbd5e1; /* slate-300 */

            --border-primary: #e2e8f0; /* slate-200 */
            --border-nav: #334155; /* slate-700 */

            --scrollbar-thumb: #94a3b8;
            --scrollbar-track: #f1f5f9;
        }

        [data-theme="dark"] {
            --bg-primary: #1e293b; /* slate-800 */
            --bg-secondary: #334155; /* slate-700 */
            --bg-tertiary: #0f172a; /* slate-900 */
            --bg-nav: #0f172a; /* slate-900 */
            --bg-nav-hover: #1e293b; /* slate-800 */

            --text-primary: #e2e8f0; /* slate-200 */
            --text-secondary: #94a3b8; /* slate-400 */
            --text-muted: #64748b; /* slate-500 */
            --text-inverted: #1e293b; /* slate-800 */
            --text-nav: #94a3b8; /* slate-400 */

            --border-primary: #334155; /* slate-700 */
            --border-nav: #1e293b; /* slate-800 */

            --scrollbar-thumb: #475569;
            --scrollbar-track: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .nav-link.active { background-color: var(--bg-active-nav); color: white; font-weight: 600; }
        .view-switcher-btn.active { background-color: #eef2ff; color: #4f46e5; }
        .sort-icon { opacity: 0.5; transition: opacity 0.2s; }
        th:hover .sort-icon { opacity: 1; }
        .sort-icon.active { opacity: 1; color: #4f46e5; }
        .settings-tab.active { color: var(--bg-active-nav); border-color: var(--bg-active-nav); }
        .dashboard-filter.active { background-color: var(--bg-active-nav); color: white; }
        #main-nav { transition: width 0.3s ease-in-out; }
        #main-content { transition: margin-left 0.3s ease-in-out; }
        #main-nav.collapsed { width: 5rem; }
        #main-nav.collapsed .nav-text, #main-nav.collapsed #logo-text { display: none; }
        #main-nav.collapsed .justify-center { justify-content: center; }
        #main-nav:not(.collapsed) .nav-toggle-icon-collapsed { display: none; }
        #main-nav.collapsed .nav-toggle-icon-expanded { display: none; }
        .group:hover .group-hover\:block { display: block; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        .kanban-column .sortable-ghost { background-color: #eef2ff; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-[var(--bg-tertiary)] text-[var(--text-primary)]">

    <div id="login-container" class="hidden min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md p-8 space-y-8 bg-[var(--bg-primary)] rounded-2xl shadow-lg border border-[var(--border-primary)]">
            <div class="text-center">
                 <div class="flex items-center justify-center gap-3 mb-4">
                    <svg class="h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                    <span class="text-4xl font-bold text-[var(--text-primary)]">Pivot</span>
                 </div>
                 <h2 class="mt-2 text-xl text-[var(--text-secondary)]">Sign in to your account</h2>
            </div>
            <form id="login-form" class="mt-8 space-y-6" onsubmit="handleLogin(event)">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-[var(--border-primary)] placeholder-gray-500 text-[var(--text-secondary)] rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address" value="jane.doe@pivot.com">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-[var(--border-primary)] placeholder-gray-500 text-[var(--text-secondary)] rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password" value="password123">
                    </div>
                </div>
                <p id="login-error" class="text-center text-sm text-red-500"></p>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="app-container" class="hidden h-screen w-full">
        <div class="flex h-screen">
            <nav id="main-nav" class="hidden lg:flex flex-col w-64 bg-[var(--bg-nav)] text-[var(--text-nav)]">
                <div class="flex items-center justify-center h-20 border-b border-[var(--border-nav)] px-4">
                     <div class="flex items-center gap-3">
                        <svg class="h-8 w-8 text-indigo-400 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                        <span id="logo-text" class="text-2xl font-bold text-white">Pivot</span>
                     </div>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <ul id="nav-links" class="p-4">
                        <li class="mb-2"><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--bg-nav-hover)] active" onclick="showView(event, 'dashboard-view')"><svg class="h-6 w-6 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg><span class="nav-text">Dashboard</span></a></li>
                        <li class="mb-2"><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--bg-nav-hover)]" onclick="showView(event, 'tasks-view')"><svg class="h-6 w-6 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg><span class="nav-text">Tasks</span></a></li>
                        <li class="mb-2"><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--bg-nav-hover)]" onclick="showView(event, 'projects-view')"><svg class="h-6 w-6 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg><span class="nav-text">Projects</span></a></li>
                        <li class="mb-2"><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--bg-nav-hover)]" onclick="showView(event, 'calendar-view')"><svg class="h-6 w-6 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h22.5" /></svg><span class="nav-text">Calendar</span></a></li>
                        <li class="mb-2"><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--bg-nav-hover)]" onclick="showView(event, 'timesheet-view')"><svg class="h-6 w-6 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="nav-text">Timesheet</span></a></li>
                         <li id="user-management-nav" class="mb-2 hidden"><a href="#" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--bg-nav-hover)]" onclick="showView(event, 'users-view')"><svg class="h-6 w-6 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.289 2.72a3 3 0 01-4.682-2.72 9.094 9.094 0 013.741-.479m7.289 2.72a8.97 8.97 0 01-7.289 2.72m0 0a8.97 8.97 0 01-7.289-2.72m7.289 2.72v.007A2.997 2.997 0 0118 15.75m-7.289 2.72a2.997 2.997 0 00-2.72-2.72m0 0A2.997 2.997 0 009 15.75v.007m4.94-4.94a2.997 2.997 0 01-4.94 0m0 0a2.997 2.997 0 01-4.94 0m4.94 0a2.997 2.997 0 010 4.94m-4.94-4.94a2.997 2.997 0 010 4.94" /></svg><span class="nav-text">Users</span></a></li>
                    </ul>
                </div>
                <div class="p-4 border-t border-[var(--border-nav)]"><div class="flex items-center justify-between"><div class="flex items-center"><button id="theme-sun-btn" onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-[var(--bg-nav-hover)]"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></button><button id="theme-moon-btn" onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-[var(--bg-nav-hover)] hidden"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button></div><button onclick="toggleNavbar()" class="p-2 rounded-lg hover:bg-[var(--bg-nav-hover)]"><svg class="w-6 h-6 nav-toggle-icon-expanded" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg><svg class="w-6 h-6 nav-toggle-icon-collapsed" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg></button></div></div>
            </nav>

            <main id="main-content" class="flex-1 flex flex-col overflow-hidden lg:ml-64">
                <header class="h-20 flex items-center justify-between lg:justify-end px-8 bg-[var(--bg-primary)] border-b border-[var(--border-primary)] flex-shrink-0">
                     <button id="mobile-menu-button" class="lg:hidden p-2 rounded-md text-[var(--text-muted)]"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg></button>
                     <div class="flex-1 flex items-center gap-4">
                        <div class="relative w-full max-w-xs">
                            <input type="text" id="global-search" placeholder="Search tasks, projects..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-[var(--border-primary)] bg-[var(--bg-secondary)] focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-[var(--text-muted)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg></div>
                            <div id="search-results-container" class="hidden absolute top-full mt-2 w-full rounded-md shadow-lg bg-[var(--bg-primary)] ring-1 ring-black ring-opacity-5 z-50 overflow-y-auto max-h-80"></div>
                        </div>
                     </div>
                     <div class="flex items-center gap-4">
                        <div class="relative">
                            <button id="notifications-button" class="p-2 rounded-full hover:bg-[var(--bg-secondary)] text-[var(--text-muted)] relative">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
                                <span id="notification-dot" class="hidden absolute top-1 right-1 h-2 w-2 rounded-full bg-red-500"></span>
                            </button>
                            <div id="notifications-panel" class="hidden absolute right-0 mt-2 w-80 rounded-md shadow-lg bg-[var(--bg-primary)] ring-1 ring-black ring-opacity-5 z-50"></div>
                        </div>
                        <div class="relative">
                            <div id="user-menu-button" class="flex items-center gap-4 cursor-pointer">
                                <span id="user-name" class="font-medium text-[var(--text-secondary)]"></span>
                                <img id="user-avatar" src="" alt="User Avatar" class="w-10 h-10 rounded-full">
                            </div>
                            <div id="user-menu" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-[var(--bg-primary)] ring-1 ring-black ring-opacity-5 z-50">
                                <div class="py-1">
                                    <a href="#" class="block px-4 py-2 text-sm text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]" onclick="openSettingsModal(event)">Settings</a>
                                    <div class="group relative"><a href="#" class="flex justify-between items-center w-full px-4 py-2 text-sm text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]"><span>Mute Notifications</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></a><div class="hidden group-hover:block absolute top-0 right-full mr-1 w-40 rounded-md shadow-lg bg-[var(--bg-primary)] ring-1 ring-black ring-opacity-5"><a href="#" class="block px-4 py-2 text-sm text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]">For 30 minutes</a><a href="#" class="block px-4 py-2 text-sm text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]">For 1 hour</a><a href="#" class="block px-4 py-2 text-sm text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]">For 4 hours</a><a href="#" class="block px-4 py-2 text-sm text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]">For 8 hours</a><a href="#" class="block px-4 py-2 text-sm text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]">Custom...</a></div></div>
                                    <a href="#" onclick="handleLogout()" class="block px-4 py-2 text-sm text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]">Logout</a>
                                </div>
                            </div>
                        </div>
                     </div>
                </header>
                
                <div class="flex-1 overflow-y-auto p-4 md:p-8">
                    <div id="dashboard-view" class="main-view"></div>
                    <div id="ticket-detail-view" class="main-view hidden"></div>
                    <div id="tasks-view" class="main-view hidden"></div>
                    <div id="timesheet-view" class="main-view hidden"></div>
                    <div id="users-view" class="main-view hidden"></div>
                    <div id="projects-view" class="main-view hidden"></div>
                    <div id="calendar-view" class="main-view hidden"></div>

                    <footer class="text-center py-8 text-[var(--text-muted)] text-sm">© 2024 Pivot.com. All rights reserved.</footer>
                </div>
            </main>
        </div>
    </div>
    <div id="modals-container"></div>
    
    <script>
    (function() { // Start of IIFE
        // --- DATA ---
        let userData = {'jane.doe@pivot.com': { id: 'JD', name: 'Jane Doe', avatar: 'https://placehold.co/40x40/fecaca/991b1b?text=JD', password: 'password123', role: 'Admin' },'john.appleseed@pivot.com': { id: 'JA', name: 'John Appleseed', avatar: 'https://placehold.co/40x40/c7d2fe/3730a3?text=JA', password: 'password123', role: 'Member' },'maria.garcia@pivot.com': { id: 'MG', name: 'Maria Garcia', avatar: 'https://placehold.co/40x40/d1fae5/10b981?text=MA', password: 'password123', role: 'Member' },'lee.smith@pivot.com': { id: 'LS', name: 'Lee Smith', avatar: 'https://placehold.co/40x40/E2E8F0/475569?text=LS', password: 'password123', role: 'Member' }};
        const projectData = {'PROJ-1': { name: 'Q3 Marketing Campaign', description: 'All tasks related to the upcoming Q3 marketing push.', color: 'bg-blue-200' },'PROJ-2': { name: 'New Mobile App', description: 'Development of the new iOS and Android mobile applications.', color: 'bg-green-200' },'PROJ-3': { name: 'Website Redesign', description: 'A complete overhaul of the main company website.', color: 'bg-purple-200' },};
        let taskData = {'TKT-001': { title: 'Design the new dashboard interface', description: 'Create a modern and intuitive dashboard design...', priority: 'High', status: 'In Progress', dueDate: '2025-07-30', endDate: 'Not set', timeEstimate: '8 hours', assignees: [{ n: 'JD' }, { n: 'JA' }], subtasks: ['TKT-007', 'TKT-008'], lastActivity: '2025-06-30T10:00:00Z', attachments: [], projectId: 'PROJ-3', comments: [] },'TKT-002': { title: 'Finalize Q3 marketing budget', description: 'Review and finalize the marketing budget...', priority: 'High', status: 'To Do', dueDate: '2025-08-05', endDate: 'Not set', timeEstimate: '4 hours', assignees: [{ n: 'JA' }], lastActivity: '2025-06-29T11:00:00Z', attachments: [], projectId: 'PROJ-1', comments: [] },'TKT-003': { title: 'Draft onboarding documentation', description: 'Create comprehensive documentation for new hires...', priority: 'Medium', status: 'To Do', dueDate: '2025-08-15', endDate: 'Not set', timeEstimate: '12 hours', assignees: [{ n: 'JD' }], lastActivity: '2025-06-28T12:00:00Z', attachments: [], projectId: 'PROJ-3', comments: [] },'TKT-004': { title: 'Review new user feedback', description: 'Go through the latest user feedback...', priority: 'Low', status: 'To Do', dueDate: '2025-07-25', endDate: 'Not set', timeEstimate: '3 hours', assignees: [{ n: 'MG' }], lastActivity: '2025-06-27T13:00:00Z', attachments: [], projectId: 'PROJ-2', comments: [] },'TKT-005': { title: 'Develop API for user authentication', description: 'Build the API endpoints for user registration...', priority: 'Medium', status: 'In Progress', dueDate: '2025-09-01', endDate: 'Not set', timeEstimate: '24 hours', assignees: [{ n: 'LS' }], lastActivity: '2025-06-26T14:00:00Z', attachments: [], projectId: 'PROJ-2', comments: [] },'TKT-006': { title: 'Setup production environment', description: 'Configure the servers and databases...', priority: 'High', status: 'Done', dueDate: '2025-07-01', endDate: 'July 5, 2024', timeEstimate: '16 hours', assignees: [{ n: 'JA' }], lastActivity: '2025-06-25T15:00:00Z', attachments: [], projectId: 'PROJ-3', comments: [] },'TKT-007': { title: 'Create wireframes for mobile view', description: 'This is a subtask...', priority: 'High', status: 'In Progress', dueDate: '2025-07-15', endDate: 'Not set', timeEstimate: '4 hours', assignees: [{ n: 'LS' }], parent: 'TKT-001', lastActivity: '2025-06-24T16:00:00Z', attachments: [], projectId: 'PROJ-2', comments: [] },'TKT-008': { title: 'Develop component library', description: 'This is a subtask...', priority: 'Medium', status: 'To Do', dueDate: '2025-07-20', endDate: 'Not set', timeEstimate: '16 hours', assignees: [{ n: 'MG' }], parent: 'TKT-001', lastActivity: '2025-06-23T17:00:00Z', attachments: [], projectId: 'PROJ-3', comments: [] }};
        const assigneeDetails = { 'JD': { name: 'Jane Doe', avatar: 'https://placehold.co/40x40/fecaca/991b1b?text=JD' }, 'JA': { name: 'John Appleseed', avatar: 'https://placehold.co/40x40/c7d2fe/3730a3?text=JA' }, 'MG': { name: 'Maria Garcia', avatar: 'https://placehold.co/40x40/d1fae5/10b981?text=MA' }, 'LS': { name: 'Lee Smith', avatar: 'https://placehold.co/40x40/E2E8F0/475569?text=LS' } };
        let timesheetData = { '2025-06-30': [ { id: 1, ticketId: 'TKT-001', hours: 4.5 }, { id: 2, ticketId: 'TKT-005', hours: 3.5 } ], '2025-07-01': [ { id: 3, ticketId: 'TKT-001', hours: 8 } ] };
        let notifications = [];

        // --- STATE ---
        let currentSort = { column: 'dueDate', direction: 'asc' };
        let currentTaskViewMode = 'grid';
        let currentWeekStart = getStartOfWeek(new Date());
        let charts = {};
        let dashboardFilter = 'week';
        let currentProjectFilter = null;
        let calendarDate = new Date();

        // --- NEW & ENHANCED FUNCTIONS ---
        function setDashboardFilter(filter, element) { dashboardFilter = filter; document.querySelectorAll('.dashboard-filter').forEach(btn => btn.classList.remove('active')); element.classList.add('active'); renderDashboard(); }
        function renderDashboard() {
            const container = document.getElementById('dashboard-view');
            if (!container) return;
            Object.values(charts).forEach(chart => chart.destroy());
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

            const myTasksHtml = Object.entries(taskData)
                .filter(([id, task]) => task.assignees.some(a => a.n === currentUser.id) && task.status !== 'Done')
                .slice(0, 5)
                .map(([id, task]) => `
                    <div class="flex items-center justify-between p-3 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border-primary)] hover:border-indigo-400 cursor-pointer" onclick="openTaskFromList('${id}')">
                        <p class="font-medium text-[var(--text-secondary)]">${task.title}</p>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${task.priority === 'High' ? 'bg-red-100 text-red-700' : task.priority === 'Medium' ? 'bg-orange-100 text-orange-700' : 'bg-yellow-100 text-yellow-700'}">${task.priority}</span>
                    </div>`).join('');

            container.innerHTML = `
                <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4"><h1 class="text-3xl font-bold text-[var(--text-primary)]">Dashboard</h1><div id="dashboard-filter-group" class="flex items-center gap-1 p-1 bg-[var(--bg-secondary)] border border-[var(--border-primary)] rounded-lg"><button class="dashboard-filter px-3 py-1 text-sm rounded-md" onclick="setDashboardFilter('today', this)">Today</button><button class="dashboard-filter px-3 py-1 text-sm rounded-md" onclick="setDashboardFilter('week', this)">This Week</button><button class="dashboard-filter px-3 py-1 text-sm rounded-md" onclick="setDashboardFilter('month', this)">This Month</button></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-6"><div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)]"><p class="text-sm text-[var(--text-muted)]">My Action Items</p><p id="action-items-count" class="text-3xl font-bold"></p></div><div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)]"><p class="text-sm text-[var(--text-muted)]" id="time-spent-label">Time This Week</p><p id="time-spent-total" class="text-3xl font-bold"></p></div><div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)]"><p class="text-sm text-[var(--text-muted)]">Tasks In Progress</p><p id="inprogress-count" class="text-3xl font-bold"></p></div><div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)]"><p class="text-sm text-[var(--text-muted)]">Overdue Tasks</p><p id="overdue-count" class="text-3xl font-bold text-red-500"></p></div></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)]"><h3 class="font-semibold mb-4">My Tasks</h3><div class="space-y-3">${myTasksHtml || '<p class="text-sm text-center text-[var(--text-muted)]">No assigned tasks.</p>'}</div></div>
                        <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)]"><h3 class="font-semibold mb-4">Tasks Progress</h3><div class="h-64"><canvas id="progress-chart"></canvas></div></div>
                    </div>
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)]"><h3 class="font-semibold mb-4">Recent Activity</h3><div id="activity-feed" class="space-y-4"></div></div>
                        <div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)]"><h3 class="font-semibold mb-4">Tasks by Assignee</h3><div class="h-64 flex justify-center"><canvas id="assignee-chart"></canvas></div></div>
                    </div>
                </div>`;
            
            document.querySelector(`#dashboard-filter-group button[onclick*="'${dashboardFilter}'"]`).classList.add('active');
            const now = new Date(); const startOfWeek = getStartOfWeek(now); const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const filteredTaskEntries = Object.entries(taskData).filter(([id, task]) => { const taskDate = new Date(task.lastActivity); if (dashboardFilter === 'today') return taskDate.toDateString() === now.toDateString(); if (dashboardFilter === 'week') return taskDate >= startOfWeek; if (dashboardFilter === 'month') return taskDate >= startOfMonth; return true; });
            const filteredTasks = Object.fromEntries(filteredTaskEntries);
            const myActionItems = Object.values(filteredTasks).filter(t => t.assignees.some(a => a.n === currentUser.id) && t.status !== 'Done'); document.getElementById('action-items-count').textContent = myActionItems.length;
            const inProgressCount = Object.values(filteredTasks).filter(t => t.status === 'In Progress').length; document.getElementById('inprogress-count').textContent = inProgressCount;
            const overdueCount = Object.values(taskData).filter(t => t.status !== 'Done' && new Date(t.dueDate) < now).length; document.getElementById('overdue-count').textContent = overdueCount;
            const timeLabel = document.getElementById('time-spent-label'); let totalHours = 0; const timeEntriesToSum = Object.entries(timesheetData).filter(([dateString, entries]) => { const entryDate = new Date(dateString); if (dashboardFilter === 'today') return entryDate.toDateString() === now.toDateString(); if (dashboardFilter === 'week') return entryDate >= startOfWeek; if (dashboardFilter === 'month') return entryDate >= startOfMonth; return false; });
            timeEntriesToSum.forEach(([, entries]) => { totalHours += entries.reduce((acc, entry) => acc + parseFloat(entry.hours || 0), 0); });
            if (dashboardFilter === 'today') timeLabel.textContent = 'Time Today'; else if (dashboardFilter === 'week') timeLabel.textContent = 'Time This Week'; else if (dashboardFilter === 'month') timeLabel.textContent = 'Time This Month';
            document.getElementById('time-spent-total').textContent = `${totalHours.toFixed(2)} hrs`;
            const statusCounts = { 'To Do': 0, 'In Progress': 0, 'Done': 0 }; const assigneeCounts = {}; Object.values(assigneeDetails).forEach(a => assigneeCounts[a.name] = 0);
            Object.values(filteredTasks).forEach(task => { if (task.status) statusCounts[task.status]++; task.assignees.forEach(a => { const assigneeName = assigneeDetails[a.n].name; if (assigneeCounts[assigneeName] !== undefined) assigneeCounts[assigneeName]++; }); });
            document.getElementById('activity-feed').innerHTML = filteredTaskEntries.slice(0, 5).map(([id, task]) => `<div class="flex items-start gap-3 text-sm"><div class="w-1.5 h-1.5 mt-1.5 rounded-full bg-indigo-500 flex-shrink-0"></div><div><p class="text-[var(--text-secondary)]"><span class="font-semibold text-[var(--text-primary)]">${id}</span> was updated</p><p class="text-xs text-[var(--text-muted)]">${new Date(task.lastActivity).toLocaleDateString()}</p></div></div>`).join('');
            const progressCtx = document.getElementById('progress-chart').getContext('2d'); charts.progress = new Chart(progressCtx, { type: 'bar', data: { labels: Object.keys(statusCounts), datasets: [{ label: '# of Tasks', data: Object.values(statusCounts), backgroundColor: ['#fbbf24', '#f97316', '#16a34a'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-muted)' } }, x: { ticks: { color: 'var(--text-muted)' } } } } });
            const assigneeCtx = document.getElementById('assignee-chart').getContext('2d'); charts.assignee = new Chart(assigneeCtx, { type: 'pie', data: { labels: Object.keys(assigneeCounts), datasets: [{ data: Object.values(assigneeCounts), backgroundColor: ['#fecaca', '#c7d2fe', '#d1fae5', '#E2E8F0'], borderColor: 'var(--bg-primary)', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: 'var(--text-muted)' } } } } });
        }
        function openCreateTaskModal() { const modalsContainer = document.getElementById('modals-container'); if (!modalsContainer) return; const assigneeOptions = Object.entries(assigneeDetails).map(([id, user]) => `<option value="${id}">${user.name}</option>`).join(''); const projectOptions = Object.entries(projectData).map(([id, proj]) => `<option value="${id}">${proj.name}</option>`).join(''); modalsContainer.innerHTML = `<div id="create-task-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-[var(--bg-primary)] rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col"><div class="flex justify-between items-center p-6 border-b border-[var(--border-primary)]"><h2 class="text-2xl font-bold text-[var(--text-primary)]">Create New Task</h2><button onclick="closeCreateTaskModal()" class="text-[var(--text-muted)] hover:text-[var(--text-primary)] text-3xl">&times;</button></div><form id="create-task-form" class="flex-1 p-6 space-y-4 overflow-y-auto"><div><label for="task-project" class="block text-sm font-medium text-[var(--text-secondary)]">Project</label><select id="task-project" name="project" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2">${projectOptions}</select></div><div><label for="task-title" class="block text-sm font-medium text-[var(--text-secondary)]">Title</label><input type="text" id="task-title" name="title" required class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></div><div><label for="task-description" class="block text-sm font-medium text-[var(--text-secondary)]">Description</label><textarea id="task-description" name="description" rows="4" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></textarea></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="task-assignee" class="block text-sm font-medium text-[var(--text-secondary)]">Assignee</label><select id="task-assignee" name="assignee" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2">${assigneeOptions}</select></div><div><label for="task-priority" class="block text-sm font-medium text-[var(--text-secondary)]">Priority</label><select id="task-priority" name="priority" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"><option>Low</option><option selected>Medium</option><option>High</option></select></div></div><div><label for="task-due-date" class="block text-sm font-medium text-[var(--text-secondary)]">Due Date</label><input type="date" id="task-due-date" name="dueDate" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></div></form><div class="p-4 bg-[var(--bg-secondary)] border-t border-[var(--border-primary)] flex justify-end gap-2"><button type="button" onclick="closeCreateTaskModal()" class="px-4 py-2 text-sm font-medium rounded-md border border-[var(--border-primary)]">Cancel</button><button type="button" onclick="handleCreateTask()" class="px-4 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white">Save Task</button></div></div></div>`; }
        function closeCreateTaskModal() { const modal = document.getElementById('create-task-modal'); if (modal) modal.remove(); }
        function handleCreateTask() { const form = document.getElementById('create-task-form'); const newId = 'TKT-' + String(Object.keys(taskData).length + 1).padStart(3, '0'); taskData[newId] = { title: form.title.value, description: form.description.value, priority: form.priority.value, status: 'To Do', dueDate: form.dueDate.value, endDate: 'Not set', timeEstimate: '0 hours', assignees: [{ n: form.assignee.value }], subtasks: [], lastActivity: new Date().toISOString(), projectId: form.project.value, comments: [] }; closeCreateTaskModal(); renderTasks(); addNotification(`New task created: ${newId}`);}
        function initDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                new Sortable(column, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        const taskId = evt.item.dataset.taskId;
                        const newStatus = evt.to.dataset.status;
                        if(taskData[taskId]) {
                            taskData[taskId].status = newStatus;
                            taskData[taskId].lastActivity = new Date().toISOString();
                            renderTasks();
                            addNotification(`Task ${taskId} moved to ${newStatus}`);
                        }
                    }
                });
            });
        }
        function addComment(taskId) { const commentInput = document.getElementById(`comment-input-${taskId}`); const text = commentInput.value.trim(); if (!text) return; const currentUser = JSON.parse(sessionStorage.getItem('currentUser')); const newComment = { userId: currentUser.id, text: text, timestamp: new Date().toISOString() }; taskData[taskId].comments.push(newComment); taskData[taskId].lastActivity = new Date().toISOString(); commentInput.value = ''; openTaskFromList(taskId); addNotification(`${currentUser.name} commented on ${taskId}`); }
        function renderCalendar() { const container = document.getElementById('calendar-view'); if (!container) return; const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; let header = `<div class="flex items-center justify-between mb-6 bg-[var(--bg-primary)] p-4 rounded-lg shadow-sm border border-[var(--border-primary)]"><button onclick="changeMonth(-1)" class="p-2 rounded-md hover:bg-[var(--bg-secondary)] text-[var(--text-muted)]">‹</button><h2 class="text-2xl font-bold">${monthNames[calendarDate.getMonth()]} ${calendarDate.getFullYear()}</h2><button onclick="changeMonth(1)" class="p-2 rounded-md hover:bg-[var(--bg-secondary)] text-[var(--text-muted)]">›</button></div>`; let calendarHTML = '<div class="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200">'; const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; calendarHTML += days.map(d => `<div class="text-center font-semibold p-2 bg-[var(--bg-secondary)] text-[var(--text-muted)] text-sm">${d}</div>`).join(''); const date = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1); const firstDay = date.getDay(); for (let i = 0; i < firstDay; i++) { calendarHTML += '<div></div>'; } while (date.getMonth() === calendarDate.getMonth()) { const dateStr = date.toISOString().split('T')[0]; const tasksOnDay = Object.entries(taskData).filter(([id, task]) => task.dueDate === dateStr); const tasksHTML = tasksOnDay.map(([id, task]) => `<div class="text-xs p-1 my-1 rounded ${task.priority === 'High' ? 'bg-red-200' : 'bg-blue-200'} cursor-pointer" onclick="openTaskFromList('${id}')">${task.title}</div>`).join(''); calendarHTML += `<div class="bg-[var(--bg-primary)] p-2 min-h-[120px]"><div class="font-semibold text-right">${date.getDate()}</div>${tasksHTML}</div>`; date.setDate(date.getDate() + 1); } calendarHTML += '</div>'; container.innerHTML = header + calendarHTML; }
        function changeMonth(direction) { calendarDate.setMonth(calendarDate.getMonth() + direction); renderCalendar(); }
        function addNotification(message) { const newNotif = { id: Date.now(), message: message, read: false, timestamp: new Date() }; notifications.unshift(newNotif); updateNotificationUI(); }
        function updateNotificationUI() { const dot = document.getElementById('notification-dot'); const panel = document.getElementById('notifications-panel'); const unreadCount = notifications.filter(n => !n.read).length; if (unreadCount > 0) { dot.classList.remove('hidden'); } else { dot.classList.add('hidden'); } panel.innerHTML = `<div class="p-3 border-b border-[var(--border-primary)] flex justify-between items-center"><h4 class="font-semibold">Notifications</h4><button onclick="markAllAsRead()" class="text-sm text-indigo-600 hover:underline">Mark all as read</button></div><div class="max-h-80 overflow-y-auto">${notifications.map(n => `<div class="p-3 border-b border-[var(--border-primary)] text-sm ${n.read ? 'text-[var(--text-muted)]' : 'font-semibold'}">${n.message}<p class="text-xs text-[var(--text-muted)] font-normal">${n.timestamp.toLocaleTimeString()}</p></div>`).join('') || '<p class="p-4 text-center text-sm text-[var(--text-muted)]">No new notifications.</p>'}</div>`; }
        function markAllAsRead() { notifications.forEach(n => n.read = true); updateNotificationUI(); }
        
        // --- EXISTING HELPER FUNCTIONS (some with modifications)---
        const userMenuButton = document.getElementById('user-menu-button'); const userMenu = document.getElementById('user-menu'); const notificationsButton = document.getElementById('notifications-button'); const notificationsPanel = document.getElementById('notifications-panel');
        if (userMenuButton) { userMenuButton.addEventListener('click', (event) => { event.stopPropagation(); userMenu.classList.toggle('hidden'); notificationsPanel.classList.add('hidden'); }); }
        if (notificationsButton) { notificationsButton.addEventListener('click', (event) => { event.stopPropagation(); notificationsPanel.classList.toggle('hidden'); userMenu.classList.add('hidden'); }); }
        document.addEventListener('click', (event) => { if (userMenu && !userMenu.classList.contains('hidden') && !userMenuButton.contains(event.target)) { userMenu.classList.add('hidden'); } if (notificationsPanel && !notificationsPanel.classList.contains('hidden') && !notificationsButton.contains(event.target)) { notificationsPanel.classList.add('hidden'); } });
        document.getElementById('global-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('search-results-container');
            if (searchTerm.length < 2) { resultsContainer.classList.add('hidden'); return; }
            let resultsHTML = '';
            // Search Tasks
            const taskResults = Object.entries(taskData).filter(([id, task]) => id.toLowerCase().includes(searchTerm) || task.title.toLowerCase().includes(searchTerm));
            if(taskResults.length > 0) { resultsHTML += '<div class="px-4 py-2 text-xs font-semibold uppercase text-[var(--text-muted)]">Tasks</div>'; taskResults.forEach(([id, task]) => { resultsHTML += `<a href="#" onclick="event.preventDefault(); openTaskFromList('${id}'); document.getElementById('search-results-container').classList.add('hidden');" class="block px-4 py-2 text-sm hover:bg-[var(--bg-secondary)]">${id}: ${task.title}</a>`; }); }
            // Search Projects
            const projectResults = Object.entries(projectData).filter(([id, proj]) => id.toLowerCase().includes(searchTerm) || proj.name.toLowerCase().includes(searchTerm));
            if(projectResults.length > 0) { resultsHTML += '<div class="px-4 py-2 text-xs font-semibold uppercase text-[var(--text-muted)]">Projects</div>'; projectResults.forEach(([id, proj]) => { resultsHTML += `<a href="#" onclick="event.preventDefault(); filterTasksByProject('${id}'); document.getElementById('search-results-container').classList.add('hidden');" class="block px-4 py-2 text-sm hover:bg-[var(--bg-secondary)]">${id}: ${proj.name}</a>`; }); }
            if (resultsHTML) { resultsContainer.innerHTML = resultsHTML; resultsContainer.classList.remove('hidden'); } else { resultsContainer.classList.add('hidden'); }
        });
        function openSettingsModal(event) { event.preventDefault(); const modalsContainer = document.getElementById('modals-container'); if(!modalsContainer) return; const currentUser = JSON.parse(sessionStorage.getItem('currentUser')); modalsContainer.innerHTML = `<div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-[var(--bg-primary)] rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center p-6 border-b border-[var(--border-primary)]"><h2 class="text-2xl font-bold text-[var(--text-primary)]">Settings</h2><button onclick="closeSettingsModal()" class="text-[var(--text-muted)] hover:text-[var(--text-primary)] text-3xl">&times;</button></div><div class="flex-1 flex flex-col md:flex-row overflow-hidden"><div class="p-6 border-b md:border-b-0 md:border-r border-[var(--border-primary)]"><nav class="flex flex-row md:flex-col gap-2"><a href="#" class="settings-tab active whitespace-nowrap px-3 py-2 text-sm font-medium rounded-md border-b-2 md:border-b-0 md:border-l-2 border-transparent" onclick="switchSettingsTab(event, 'profile')">Profile</a><a href="#" class="settings-tab whitespace-nowrap px-3 py-2 text-sm font-medium rounded-md border-b-2 md:border-b-0 md:border-l-2 border-transparent" onclick="switchSettingsTab(event, 'password')">Password</a><a href="#" class="settings-tab whitespace-nowrap px-3 py-2 text-sm font-medium rounded-md border-b-2 md:border-b-0 md:border-l-2 border-transparent" onclick="switchSettingsTab(event, 'notifications')">Notifications</a></nav></div><div class="flex-1 p-6 overflow-y-auto"><div id="profile-tab-content" class="settings-tab-content space-y-6"><div><label class="block text-sm font-medium text-[var(--text-secondary)]">Full Name</label><input type="text" value="${currentUser.name}" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></div><div><label class="block text-sm font-medium text-[var(--text-secondary)]">Email Address</label><input type="email" value="${currentUser.email}" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2" readonly></div><div><label class="block text-sm font-medium text-[var(--text-secondary)]">Profile Picture</label><div class="mt-2 flex items-center gap-4"><img src="${currentUser.avatar.replace('40x40', '80x80')}" class="w-20 h-20 rounded-full"><button class="px-3 py-1.5 text-sm font-medium bg-[var(--bg-secondary)] border border-[var(--border-primary)] rounded-md">Change</button></div></div></div><div id="password-tab-content" class="settings-tab-content hidden space-y-6"><div><label class="block text-sm font-medium text-[var(--text-secondary)]">Current Password</label><input type="password" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></div><div><label class="block text-sm font-medium text-[var(--text-secondary)]">New Password</label><input type="password" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></div><div><label class="block text-sm font-medium text-[var(--text-secondary)]">Confirm New Password</label><input type="password" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></div></div><div id="notifications-tab-content" class="settings-tab-content hidden space-y-6"><h4 class="font-semibold">Email Notifications</h4><label class="flex items-center"><input type="checkbox" checked class="h-4 w-4 text-indigo-600 rounded"> <span class="ml-2">When a task is assigned to me</span></label><label class="flex items-center"><input type="checkbox" checked class="h-4 w-4 text-indigo-600 rounded"> <span class="ml-2">When I'm mentioned in a comment</span></label><label class="flex items-center"><input type="checkbox" class="h-4 w-4 text-indigo-600 rounded"> <span class="ml-2">Weekly summary of my tasks</span></label></div></div></div><div class="p-4 bg-[var(--bg-secondary)] border-t border-[var(--border-primary)] flex justify-end gap-2"><button onclick="closeSettingsModal()" class="px-4 py-2 text-sm font-medium rounded-md border border-[var(--border-primary)]">Cancel</button><button class="px-4 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white">Save Changes</button></div></div></div>`; if (userMenu) userMenu.classList.add('hidden'); }
        function closeSettingsModal() { const modal = document.getElementById('settings-modal'); if(modal) modal.remove(); }
        function switchSettingsTab(event, tabName) { event.preventDefault(); document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active')); document.getElementById(`${tabName}-tab-content`).classList.remove('hidden'); event.currentTarget.classList.add('active'); }
        function getStartOfWeek(date) { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff));}
        function showView(event, viewId) { if (event) event.preventDefault(); document.querySelectorAll('.main-view').forEach(view => view.classList.add('hidden')); const targetView = document.getElementById(viewId); if (targetView) targetView.classList.remove('hidden'); if (viewId === 'dashboard-view') { renderDashboard(); } else if (viewId === 'tasks-view') { if(targetView.innerHTML.trim() === '') createTasksViewDOM(); renderTasks(); setTaskViewMode(currentTaskViewMode); } else if (viewId === 'timesheet-view') { if(targetView.innerHTML.trim() === '') createTimesheetViewDOM(); renderTimesheet(); } else if (viewId === 'users-view') { renderUserManagement(); } else if (viewId === 'projects-view') { renderProjectsPage(); } else if (viewId === 'calendar-view') { renderCalendar(); } else if (viewId === 'ticket-detail-view' && targetView.innerHTML.trim() === '') { openTaskFromList('TKT-001'); } if (event) { document.querySelectorAll('#nav-links .nav-link').forEach(link => link.classList.remove('active')); event.currentTarget.classList.add('active'); } }
        function openTaskFromList(taskId) { document.getElementById('ticket-detail-view').innerHTML = createTaskDetailHTML(taskId); showView(null, 'ticket-detail-view'); }
        function changeWeek(direction) { currentWeekStart.setDate(currentWeekStart.getDate() + 7 * direction); document.getElementById('week-picker').valueAsDate = currentWeekStart; renderTimesheet(); }
        function addTimesheetEntry(dateString) { if (!timesheetData[dateString]) { timesheetData[dateString] = []; } const newId = Date.now(); timesheetData[dateString].push({ id: newId, ticketId: '', hours: 0 }); renderTimesheet(); }
        function removeTimesheetEntry(dateString, entryId) { timesheetData[dateString] = timesheetData[dateString].filter(entry => entry.id !== entryId); renderTimesheet(); }
        function updateTimesheetEntry(dateString, entryId, field, value) { const entry = timesheetData[dateString].find(e => e.id === entryId); if (entry) { entry[field] = value; } renderTimesheet(); }
        function createTaskDetailHTML(taskId) { const task = taskData[taskId]; if (!task) return `<div class="bg-[var(--bg-primary)] rounded-2xl shadow-lg border border-[var(--border-primary)] p-8"><p class="text-[var(--text-primary)]">Task not found.</p></div>`; const assigneesHTML = task.assignees.map(a => { const d = assigneeDetails[a.n]; return `<div class="flex items-center gap-3"><img src="${d.avatar}" alt="${d.name}" class="w-10 h-10 rounded-full"><span class="font-medium text-[var(--text-secondary)]">${d.name}</span></div>`; }).join(''); const priorityButton = (p, taskP) => { const c = { Low: 'bg-yellow-100 text-yellow-800', Medium: 'bg-orange-100 text-orange-800', High: 'bg-red-100 text-red-800' }; return `<button class="px-3 py-1 text-sm rounded-full ${c[p]} ${p === taskP ? 'ring-2 ring-indigo-500' : ''}">${p}</button>`; }; const parentLinkHTML = task.parent ? `<div onclick="openTaskFromList('${task.parent}')" class="flex items-center gap-1 text-sm text-[var(--text-muted)] hover:text-indigo-600 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg><span>Back to Parent Task</span></div>` : ''; const subtasksHTML = (task.subtasks && task.subtasks.length > 0) ? `<div class="mb-8"><h2 class="text-lg font-semibold text-[var(--text-primary)] mb-4">Subtasks (${task.subtasks.length})</h2><div class="space-y-3">${task.subtasks.map(subId => { const sub = taskData[subId]; const assignee = assigneeDetails[sub.assignees[0].n]; return `<div class="flex items-center justify-between p-3 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border-primary)] hover:border-indigo-400"><div class="flex items-center gap-3"><input type="checkbox" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 bg-[var(--bg-primary)]"><a href="#" class="font-medium text-[var(--text-secondary)] hover:text-indigo-600" onclick="event.preventDefault(); openTaskFromList('${subId}');">${sub.title}</a></div><div class="flex items-center gap-3"><img src="${assignee.avatar.replace('40x40', '24x24')}" alt="${assignee.name}" class="w-7 h-7 rounded-full border-2 border-[var(--bg-primary)]"><span class="text-sm text-[var(--text-muted)]">${new Date(sub.dueDate).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span></div></div>`; }).join('')}</div></div>` : ''; const attachmentsHTML = `<div class="mt-8"><h3 class="text-lg font-semibold mb-3 text-[var(--text-primary)]">Attachments</h3><div id="attachments-list" class="space-y-3 mb-4">${task.attachments.map(file => `<div class="flex items-center p-3 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border-primary)]"><svg class="w-6 h-6 mr-3 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg><span class="font-medium text-slate-700">${file.name}</span></div>`).join('')}</div><input type="file" id="file-input-${taskId}" class="hidden" onchange="handleFileChange(event, '${taskId}')"><button onclick="document.getElementById('file-input-${taskId}').click()" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>Add Attachment</button></div>`; const commentsHTML = `<div class="mt-8"><h3 class="text-lg font-semibold mb-3 text-[var(--text-primary)]">Comments</h3><div class="space-y-4 mb-4">${(task.comments || []).map(c => { const user = Object.values(userData).find(u => u.id === c.userId); return `<div class="flex items-start gap-3"><img src="${user.avatar}" class="w-10 h-10 rounded-full"><div class="p-3 bg-[var(--bg-secondary)] rounded-lg w-full"><div class="flex justify-between items-center"><p class="font-semibold">${user.name}</p><p class="text-xs text-[var(--text-muted)]">${new Date(c.timestamp).toLocaleString()}</p></div><p class="mt-1">${c.text}</p></div></div>`; }).join('')}</div><div class="flex items-start gap-3"><img src="${JSON.parse(sessionStorage.getItem('currentUser')).avatar}" class="w-10 h-10 rounded-full"><div class="w-full"><textarea id="comment-input-${taskId}" placeholder="Add a comment..." class="w-full p-2 rounded-md border-[var(--border-primary)] bg-[var(--bg-secondary)]"></textarea><button onclick="addComment('${taskId}')" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium">Post</button></div></div></div>`; return `<div class="bg-[var(--bg-primary)] rounded-2xl shadow-lg border border-[var(--border-primary)]"><div class="p-6 border-b border-[var(--border-primary)]"><div class="flex flex-wrap items-start justify-between gap-4"><div><div class="flex items-center gap-3"><span class="bg-indigo-100 text-indigo-600 text-sm font-semibold px-3 py-1 rounded-full">${taskId}</span>${parentLinkHTML}</div><h1 class="text-3xl font-bold mt-2 text-[var(--text-primary)]">${task.title}</h1></div><div class="flex items-center gap-2"><button class="px-4 py-2 bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)] rounded-lg text-sm font-medium text-[var(--text-secondary)]">Share</button><button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium">Complete Task</button></div></div></div><div class="flex flex-col lg:flex-row"><div class="w-full lg:w-2/3 p-6"><div class="mb-8"><h2 class="text-lg font-semibold text-[var(--text-primary)] mb-3">Description</h2><p class="text-[var(--text-secondary)] leading-relaxed">${task.description}</p></div>${subtasksHTML}${attachmentsHTML}${commentsHTML}</div><div class="w-full lg:w-1/3 p-6 border-t lg:border-t-0 lg:border-l border-[var(--border-primary)]"><div class="space-y-6"><div><h3 class="text-sm font-semibold text-[var(--text-muted)] uppercase tracking-wider">Assignees</h3><div class="mt-3 space-y-3">${assigneesHTML}</div></div><div><h3 class="text-sm font-semibold text-[var(--text-muted)] uppercase tracking-wider">Priority</h3><div class="mt-3 flex space-x-2">${priorityButton('Low', task.priority)}${priorityButton('Medium', task.priority)}${priorityButton('High', 'task.priority')}</div></div><div><h3 class="text-sm font-semibold text-[var(--text-muted)] uppercase tracking-wider">Dates</h3><div class="mt-3 space-y-2"><div class="flex justify-between items-center"><span class="text-[var(--text-secondary)]">Due Date</span><span class="font-medium text-[var(--text-primary)]">${new Date(task.dueDate).toLocaleDateString()}</span></div><div class="flex justify-between items-center"><span class="text-[var(--text-secondary)]">End Date</span><span class="font-medium text-[var(--text-muted)]">${task.endDate}</span></div></div></div><div><h3 class="text-sm font-semibold text-[var(--text-muted)] uppercase tracking-wider">Time Estimate</h3><div class="mt-3"><span class="font-medium text-[var(--text-primary)]">${task.timeEstimate}</span></div></div></div></div></div></div>`; }
        function renderTasks() { const gridContainer = document.getElementById('tasks-grid-container'), listContainer = document.getElementById('tasks-list-container'); if(!gridContainer || !listContainer) return; gridContainer.innerHTML = ''; listContainer.innerHTML = ''; const columns = { 'To Do': [], 'In Progress': [], 'Done': [] }; let filteredTaskIds = Object.keys(taskData).filter(id => !taskData[id].parent); if (currentProjectFilter) { filteredTaskIds = filteredTaskIds.filter(id => taskData[id].projectId === currentProjectFilter); } const sortedTaskIds = filteredTaskIds.sort((a, b) => { const taskA = taskData[a], taskB = taskData[b]; let valA = taskA[currentSort.column], valB = taskB[currentSort.column]; let comp = 0; if (valA > valB) comp = 1; else if (valA < valB) comp = -1; return currentSort.direction === 'desc' ? comp * -1 : comp; }); const getSortIcon = (col) => `<svg class="sort-icon inline-block ml-1 h-4 w-4 ${currentSort.column === col ? 'active' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`; let tableHTML = `<table class="w-full text-left"><thead class="border-b border-[var(--border-primary)]"><tr><th class="p-4 font-semibold text-sm text-[var(--text-muted)] cursor-pointer" onclick="sortTable('title')">Task ${getSortIcon('title')}</th><th class="p-4 font-semibold text-sm text-[var(--text-muted)] cursor-pointer" onclick="sortTable('status')">Status ${getSortIcon('status')}</th><th class="p-4 font-semibold text-sm text-[var(--text-muted)] cursor-pointer" onclick="sortTable('dueDate')">Due Date ${getSortIcon('dueDate')}</th><th class="p-4 font-semibold text-sm text-[var(--text-muted)]">Assignees</th></tr></thead><tbody>`; sortedTaskIds.forEach(taskId => { const task = taskData[taskId]; columns[task.status].push(taskId); const assigneesList = task.assignees.map(a => `<img src="${assigneeDetails[a.n].avatar.replace('40x40','24x24')}" alt="${assigneeDetails[a.n].name}" title="${assigneeDetails[a.n].name}" class="inline-block h-7 w-7 rounded-full ring-2 ring-[var(--bg-primary)]">`).join(''); tableHTML += `<tr class="border-b border-[var(--border-primary)] hover:bg-[var(--bg-secondary)] cursor-pointer" onclick="openTaskFromList('${taskId}')"><td class="p-4 font-medium text-[var(--text-primary)]">${task.title}</td><td class="p-4 text-sm text-[var(--text-secondary)]">${task.status}</td><td class="p-4 text-sm text-[var(--text-secondary)]">${new Date(task.dueDate).toLocaleDateString()}</td><td class="p-4"><div class="flex -space-x-2 overflow-hidden">${assigneesList}</div></td></tr>`; }); tableHTML += '</tbody></table>'; if(listContainer) listContainer.innerHTML = tableHTML; let gridHTML = ''; for (const status in columns) { const taskCards = columns[status].map(taskId => { const task = taskData[taskId]; const assigneesGrid = task.assignees.map(a => `<img src="${assigneeDetails[a.n].avatar.replace('40x40','24x24')}" alt="${assigneeDetails[a.n].name}" title="${assigneeDetails[a.n].name}" class="inline-block h-6 w-6 rounded-full ring-2 ring-[var(--bg-primary)]">`).join(''); return `<div onclick="openTaskFromList('${taskId}')" data-task-id="${taskId}" class="p-4 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border-primary)] cursor-grab hover:border-indigo-400"><p class="font-medium text-[var(--text-primary)] ${task.status === 'Done' ? 'line-through text-[var(--text-muted)]' : ''}">${task.title}</p><div class="flex items-center justify-between mt-3"><span class="text-xs font-semibold px-2 py-0.5 rounded-full ${task.priority === 'High' ? 'bg-red-100 text-red-700' : task.priority === 'Medium' ? 'bg-orange-100 text-orange-700' : 'bg-yellow-100 text-yellow-700'}">${task.priority}</span><div class="flex -space-x-2 overflow-hidden">${assigneesGrid}</div></div></div>`; }).join(''); gridHTML += `<div class="bg-[var(--bg-primary)] rounded-lg shadow-sm border border-[var(--border-primary)]"><h2 class="text-lg font-semibold p-4 border-b border-[var(--border-primary)] text-[var(--text-primary)]">${status} <span class="text-sm font-normal text-[var(--text-muted)]">${columns[status].length}</span></h2><div data-status="${status}" class="p-4 space-y-4 kanban-column min-h-[100px]">${taskCards}</div></div>`; } if(gridContainer) gridContainer.innerHTML = gridHTML; initDragAndDrop(); }
        function renderTimesheet() { const container = document.getElementById('timesheet-container'); if(!container) return; let html = '<div class="space-y-6">'; const weekDates = []; let weeklyTotal = 0; for (let i = 0; i < 7; i++) { const day = new Date(currentWeekStart); day.setDate(day.getDate() + i); weekDates.push(day); } weekDates.forEach(date => { const dateString = date.toISOString().split('T')[0]; const entries = timesheetData[dateString] || []; let dailyTotal = entries.reduce((acc, entry) => acc + parseFloat(entry.hours || 0), 0); weeklyTotal += dailyTotal; html += `<div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-primary)]"><div class="flex justify-between items-center mb-4"><div><h3 class="font-bold text-lg text-[var(--text-primary)]">${date.toLocaleDateString(undefined, { weekday: 'long' })}</h3><p class="text-sm text-[var(--text-muted)]">${date.toLocaleDateString()}</p></div><div class="text-right"><p class="font-bold text-lg text-[var(--text-primary)]">${dailyTotal.toFixed(2)} hrs</p><p class="text-sm text-[var(--text-muted)]">Daily Total</p></div></div><div id="entries-${dateString}" class="space-y-2">${entries.map(entry => `<div class="grid grid-cols-12 gap-2 items-center"><select onchange="updateTimesheetEntry('${dateString}', ${entry.id}, 'ticketId', this.value)" class="col-span-8 p-2 border border-[var(--border-primary)] rounded-md bg-[var(--bg-primary)] text-[var(--text-secondary)]"><option value="">Select a task...</option>${Object.keys(taskData).map(id => `<option value="${id}" ${entry.ticketId === id ? 'selected' : ''}>${id}: ${taskData[id].title}</option>`).join('')}</select><input oninput="updateTimesheetEntry('${dateString}', ${entry.id}, 'hours', this.value)" type="number" step="0.25" value="${entry.hours}" class="col-span-3 p-2 border border-[var(--border-primary)] rounded-md bg-[var(--bg-primary)] text-[var(--text-secondary)]"><button onclick="removeTimesheetEntry('${dateString}', ${entry.id})" class="col-span-1 text-[var(--text-muted)] hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>`).join('')}</div><button onclick="addTimesheetEntry('${dateString}')" class="mt-4 text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Add Entry</button></div>`; }); html += `<div class="mt-6 p-4 border-t-2 border-indigo-500 flex justify-end items-center gap-4"><p class="text-sm font-semibold text-[var(--text-muted)]">WEEKLY TOTAL</p><p class="text-2xl font-bold text-indigo-600">${weeklyTotal.toFixed(2)} hours</p></div><div class="flex justify-end mt-4"><button class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold">Submit Timesheet</button></div>`; html += '</div>'; container.innerHTML = html; }
        function sortTable(column) { if (currentSort.column === column) { currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; } else { currentSort.column = column; currentSort.direction = 'asc'; } renderTasks(); }
        function setTaskViewMode(mode) { currentTaskViewMode = mode; const gridC = document.getElementById('tasks-grid-container'), listC = document.getElementById('tasks-list-container'), gridB = document.getElementById('grid-view-btn'), listB = document.getElementById('list-view-btn'); if(!gridC || !listC || !gridB || !listB) return; if (mode === 'grid') { gridC.classList.remove('hidden'); listC.classList.add('hidden'); gridB.classList.add('active'); listB.classList.remove('active'); } else { gridC.classList.add('hidden'); listC.classList.remove('hidden'); gridB.classList.remove('active'); listB.classList.add('active'); } }
        function toggleNavbar() { const nav = document.getElementById('main-nav'), main = document.getElementById('main-content'); nav.classList.toggle('collapsed'); if (nav.classList.contains('collapsed')) { main.classList.remove('lg:ml-64'); main.classList.add('lg:ml-20'); } else { main.classList.remove('lg:ml-20'); main.classList.add('lg:ml-64'); } }
        function toggleTheme() { const html = document.documentElement; const newTheme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light'; html.setAttribute('data-theme', newTheme); localStorage.setItem('pivot-theme', newTheme); updateThemeIcons(newTheme); }
        function updateThemeIcons(theme) { const sunBtn = document.getElementById('theme-sun-btn'), moonBtn = document.getElementById('theme-moon-btn'); if(!sunBtn || !moonBtn) return; if (theme === 'dark') { sunBtn.classList.add('hidden'); moonBtn.classList.remove('hidden'); } else { sunBtn.classList.remove('hidden'); moonBtn.classList.add('hidden'); } }
        function createTasksViewDOM() { const tasksViewDiv = document.getElementById('tasks-view'); if(tasksViewDiv) tasksViewDiv.innerHTML = `<div class="flex items-center justify-between mb-6"><h1 class="text-3xl font-bold text-[var(--text-primary)]">Tasks</h1><div class="flex items-center gap-4"><button id="show-all-tasks-btn" class="hidden px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-sm font-medium" onclick="filterTasksByProject(null)">Show All</button><div class="flex items-center gap-2 p-1 bg-slate-200 rounded-lg"><button id="grid-view-btn" onclick="setTaskViewMode('grid')" class="view-switcher-btn p-2 rounded-md text-slate-600 hover:bg-slate-300"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button><button id="list-view-btn" onclick="setTaskViewMode('list')" class="view-switcher-btn p-2 rounded-md text-slate-600 hover:bg-slate-300"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></button></div><button onclick="openCreateTaskModal()" class="p-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button></div></div><div id="tasks-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div><div id="tasks-list-container" class="hidden bg-[var(--bg-primary)] rounded-lg shadow-sm border border-[var(--border-primary)] overflow-x-auto"></div>`; }
        function createTimesheetViewDOM() { const timesheetViewDiv = document.getElementById('timesheet-view'); if(timesheetViewDiv) { timesheetViewDiv.innerHTML = `<div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4"><h1 class="text-3xl font-bold text-[var(--text-primary)]">Timesheet</h1><div class="flex items-center gap-2"><button onclick="changeWeek(-1)" class="p-2 rounded-md hover:bg-[var(--bg-secondary)] text-[var(--text-muted)]">&lt; Prev</button><input type="date" id="week-picker" class="p-2 border border-[var(--border-primary)] rounded-md bg-[var(--bg-primary)] text-[var(--text-secondary)]"><button onclick="changeWeek(1)" class="p-2 rounded-md hover:bg-[var(--bg-secondary)] text-[var(--text-muted)]">Next &gt;</button></div></div><div id="timesheet-container" class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)]"></div>`; const weekPicker = document.getElementById('week-picker'); if(weekPicker) { weekPicker.valueAsDate = currentWeekStart; weekPicker.addEventListener('change', () => { const selectedDate = weekPicker.valueAsDate; selectedDate.setHours(12); currentWeekStart = getStartOfWeek(selectedDate); renderTimesheet(); }); } } }
        function handleLogin(event) { event.preventDefault(); const email = event.target.email.value; const password = event.target.password.value; const user = userData[email]; const loginError = document.getElementById('login-error'); if (user && user.password === password) { const userToStore = { id: user.id, name: user.name, avatar: user.avatar, email: email, role: user.role }; sessionStorage.setItem('currentUser', JSON.stringify(userToStore)); document.getElementById('login-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); document.getElementById('user-name').textContent = user.name; document.getElementById('user-avatar').src = user.avatar; if(user.role === 'Admin') { document.getElementById('user-management-nav').classList.remove('hidden'); } addNotification(`Welcome back, ${user.name}!`); showView(null, 'dashboard-view'); } else { loginError.textContent = 'Invalid email or password.'; } }
        function handleLogout() { sessionStorage.removeItem('currentUser'); document.getElementById('login-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); }
        window.onload = function() { const savedTheme = localStorage.getItem('pivot-theme') || 'light'; document.documentElement.setAttribute('data-theme', savedTheme); updateThemeIcons(savedTheme); const loggedInUser = sessionStorage.getItem('currentUser'); if (loggedInUser) { const user = JSON.parse(loggedInUser); document.getElementById('login-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); document.getElementById('user-name').textContent = user.name; document.getElementById('user-avatar').src = user.avatar; if(user.role === 'Admin') { document.getElementById('user-management-nav').classList.remove('hidden'); } updateNotificationUI(); showView(null, 'dashboard-view'); } else { document.getElementById('login-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); } };
        window.handleLogin = handleLogin; window.handleLogout = handleLogout; window.showView = showView; window.toggleTheme = toggleTheme; window.toggleNavbar = toggleNavbar; window.openSettingsModal = openSettingsModal; window.closeSettingsModal = closeSettingsModal; window.switchSettingsTab = switchSettingsTab; window.setDashboardFilter = setDashboardFilter; window.openCreateTaskModal = openCreateTaskModal; window.closeCreateTaskModal = closeCreateTaskModal; window.handleCreateTask = handleCreateTask; window.sortTable = sortTable; window.setTaskViewMode = setTaskViewMode; window.changeWeek = changeWeek; window.addTimesheetEntry = addTimesheetEntry; window.updateTimesheetEntry = updateTimesheetEntry; window.removeTimesheetEntry = removeTimesheetEntry; window.openTaskFromList = openTaskFromList; window.renderUserManagement = renderUserManagement; window.openUserModal = openUserModal; window.closeUserModal = closeUserModal; window.handleSaveUser = handleSaveUser; window.renderProjectsPage = renderProjectsPage; window.filterTasksByProject = filterTasksByProject; window.changeMonth = changeMonth; window.addComment = addComment; window.markAllAsRead = markAllAsRead;
        window.handleFileChange = (event, taskId) => { const file = event.target.files[0]; if (!file) return; taskData[taskId].attachments.push({ name: file.name, size: file.size }); openTaskFromList(taskId); };
        function renderUserManagement() { const container = document.getElementById('users-view'); if (!container) return; const userRows = Object.entries(userData).map(([email, user]) => `<tr class="border-b border-[var(--border-primary)]"><td class="p-4"><div class="flex items-center gap-3"><img src="${user.avatar}" class="w-10 h-10 rounded-full"><span>${user.name}</span></div></td><td class="p-4 text-[var(--text-secondary)]">${email}</td><td class="p-4 text-[var(--text-secondary)]">${user.role}</td><td class="p-4 text-right"><button class="text-indigo-600 hover:underline" onclick="openUserModal('${email}')">Edit</button></td></tr>`).join(''); container.innerHTML = `<div class="flex items-center justify-between mb-6"><h1 class="text-3xl font-bold text-[var(--text-primary)]">User Management</h1><button onclick="openUserModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Add User</button></div><div class="bg-[var(--bg-primary)] rounded-lg shadow-sm border border-[var(--border-primary)] overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-[var(--border-primary)]"><th class="p-4 font-semibold text-sm text-[var(--text-muted)]">Name</th><th class="p-4 font-semibold text-sm text-[var(--text-muted)]">Email</th><th class="p-4 font-semibold text-sm text-[var(--text-muted)]">Role</th><th class="p-4"></th></tr></thead><tbody>${userRows}</tbody></table></div>`; }
        function openUserModal(email = null) { const modalsContainer = document.getElementById('modals-container'); if (!modalsContainer) return; const user = email ? userData[email] : null; const title = user ? 'Edit User' : 'Add New User'; modalsContainer.innerHTML = `<div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"><div class="bg-[var(--bg-primary)] rounded-lg shadow-xl w-full max-w-lg"><div class="flex justify-between items-center p-6 border-b border-[var(--border-primary)]"><h2 class="text-2xl font-bold text-[var(--text-primary)]">${title}</h2><button onclick="closeUserModal()" class="text-[var(--text-muted)] hover:text-[var(--text-primary)] text-3xl">&times;</button></div><form id="user-form" class="p-6 space-y-4"><input type="hidden" name="originalEmail" value="${email || ''}"><div><label class="block text-sm font-medium">Name</label><input type="text" name="name" value="${user?.name || ''}" required class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></div><div><label class="block text-sm font-medium">Email</label><input type="email" name="email" value="${email || ''}" required class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></div><div><label class="block text-sm font-medium">Role</label><select name="role" class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"><option ${user?.role === 'Member' ? 'selected' : ''}>Member</option><option ${user?.role === 'Admin' ? 'selected' : ''}>Admin</option></select></div>${!user ? '<div><label class="block text-sm font-medium">Password</label><input type="password" name="password" required class="mt-1 block w-full rounded-md border-[var(--border-primary)] shadow-sm bg-[var(--bg-secondary)] p-2"></div>' : ''}</form><div class="p-4 bg-[var(--bg-secondary)] border-t border-[var(--border-primary)] flex justify-end gap-2"><button type="button" onclick="closeUserModal()" class="px-4 py-2 text-sm font-medium rounded-md border border-[var(--border-primary)]">Cancel</button><button type="button" onclick="handleSaveUser()" class="px-4 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white">Save Changes</button></div></div></div>`; }
        function closeUserModal() { const modal = document.getElementById('user-modal'); if (modal) modal.remove(); }
        function handleSaveUser() { const form = document.getElementById('user-form'); const originalEmail = form.originalEmail.value; const newEmail = form.email.value; const newUserData = { id: originalEmail ? userData[originalEmail].id : newEmail.substring(0,2).toUpperCase(), name: form.name.value, avatar: `https://placehold.co/40x40/cccccc/333333?text=${form.name.value.substring(0,2).toUpperCase()}`, role: form.role.value, password: form.password ? form.password.value : (originalEmail ? userData[originalEmail].password : 'password123') }; if (originalEmail && originalEmail !== newEmail) { delete userData[originalEmail]; } userData[newEmail] = newUserData; closeUserModal(); renderUserManagement(); addNotification(`User ${originalEmail ? 'updated' : 'created'}: ${newUserData.name}`);}
        function renderProjectsPage() { const container = document.getElementById('projects-view'); if(!container) return; const projectCards = Object.entries(projectData).map(([id, project]) => { const tasksInProject = Object.values(taskData).filter(t => t.projectId === id).length; return `<div class="bg-[var(--bg-primary)] p-6 rounded-lg shadow-sm border border-[var(--border-primary)] cursor-pointer hover:shadow-lg transition-shadow" onclick="filterTasksByProject('${id}')"><div class="flex justify-between items-start"><h3 class="text-xl font-bold text-[var(--text-primary)]">${project.name}</h3><span class="text-sm font-semibold px-2 py-0.5 ${project.color} rounded-full">${id}</span></div><p class="text-[var(--text-secondary)] mt-2 mb-4 h-10">${project.description}</p><div class="text-sm text-[var(--text-muted)]">${tasksInProject} tasks</div></div>` }).join(''); container.innerHTML = `<div class="flex items-center justify-between mb-6"><h1 class="text-3xl font-bold text-[var(--text-primary)]">Projects</h1><button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Add Project</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${projectCards}</div>`; }
        function filterTasksByProject(projectId) { currentProjectFilter = projectId; showView(null, 'tasks-view'); const showAllBtn = document.getElementById('show-all-tasks-btn'); if(showAllBtn) { if(projectId) { showAllBtn.classList.remove('hidden'); } else { showAllBtn.classList.add('hidden'); } } }
    })(); // End of IIFE
    </script>
</body>
</html>
